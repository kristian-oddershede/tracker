<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Personal Time Pie • Private Tracker</title>
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --bg: #0f1724;
      --card: #0b1220;
      --muted: #94a3b8;
      --accent: #60a5fa;
      --glass: rgba(255,255,255,0.03);
      --card-2: #0c1420;
      --success: #22c55e;
    }
    *{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;}
    html,body{height:100%;margin:0;background:#0f1724;color:#e6eef8;}
    .wrap{max-width:920px;margin:36px auto;padding:20px; background: linear-gradient(180deg,#071021 0%, #071827 80%); border-radius:12px;}
    header{display:flex;flex-direction:column;align-items:flex-start;gap:6px;margin-bottom:18px}
    header h1{font-size:20px;margin:0}
    header .small.muted{color:var(--muted);}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);border-radius:12px;padding:16px;box-shadow:0 6px 18px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03)}
    .input-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    input[type="text"]{flex:1;padding:10px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:var(--glass);color:inherit;min-width:160px;}
    button{background:var(--accent);border:none;color:#04233a;padding:10px 16px;border-radius:10px;cursor:pointer;font-weight:600}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);padding:8px 12px}
    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .chart-area{display:grid;grid-template-columns:1fr 260px;gap:14px;margin-top:14px}
    @media(max-width:860px){ .chart-area{grid-template-columns:1fr} .right-col{order:3} }
    .right-col{display:flex;flex-direction:column;gap:10px}
    canvas{background:transparent;border-radius:8px}
    .filter-row{display:flex;gap:8px;align-items:center;justify-content:flex-end}
    .entries{max-height:260px;overflow:auto;padding:8px;border-radius:8px;background:rgba(0,0,0,0.06);border:1px dashed rgba(255,255,255,0.02)}
    .entry{display:flex;justify-content:space-between;gap:10px;padding:8px;border-radius:8px;align-items:center}
    .pill{background:rgba(255,255,255,0.03);padding:6px 10px;border-radius:999px;font-weight:600}
    .muted{color:var(--muted);font-size:13px}
    .top-meta{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:10px}
    .small{font-size:13px;color:var(--muted)}
    .row{display:flex;gap:8px;align-items:center}
    .linklike{background:transparent;border:none;color:var(--accent);cursor:pointer;text-decoration:underline;padding:0}
    footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px; background: var(--card-2); padding:20px 0; border-radius:0 0 12px 12px;}
    .summary{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .danger{background:#ff7878;color:#1b0b0b;padding:8px 10px;border-radius:8px;border:none;cursor:pointer}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div style="display:flex;align-items:center;gap:12px;">
        <h1>Personal Time Pie</h1>
        <div class="small muted">By Kristian Dahlmann Oddershede</div>
      </div>
    </header>

    <div class="card">
      <div class="top-meta">
        <div style="display:flex;gap:10px;align-items:center;">
          <label style="font-weight:700">Log activity</label>
        </div>
        <div class="summary">
          <div class="small">Total entries: <span id="totalEntries">0</span></div>
          <div class="small">Total time: <strong id="totalTime">0m</strong></div>
        </div>
      </div>

      <div class="input-row" role="form" aria-label="Log activity">
        <input id="labelInput" type="text" placeholder='Enter activity name' maxlength="80" />
        <button id="startStopBtn">Start</button>

        <div id="timerDisplay" class="small muted"></div>

        <div style="margin-left:auto" class="controls">
          <button id="exportBtn" class="ghost">Export JSON</button>
          <label class="ghost" style="padding:8px;border-radius:8px;display:inline-flex;align-items:center">
            <input id="importFile" type="file" accept="application/json" style="display:none"/>
            Import
          </label>
          <button id="clearBtn" class="ghost">Clear all</button>
        </div>
      </div>

      <div class="chart-area">
        <div>
          <div class="filter-row">
            <div class="small">View:</div>
            <select id="viewSelect" class="num" style="width:auto">
              <option value="24h">Last 24 hours</option>
              <option value="all">All time</option>
            </select>
            <button id="refreshBtn" class="ghost">Refresh</button>
          </div>

          <div style="margin-top:12px" class="card" id="chartCard">
            <canvas id="pieChart" width="400" height="300" aria-label="Time distribution pie chart"></canvas>
          </div>
        </div>

        <div class="right-col">
          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <div class="small">Entries</div>
            </div>
            <div id="entries" class="entries" aria-live="polite"></div>
          </div>

          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <div class="small">Export / Backup</div>
            </div>
            <div style="display:flex;gap:8px;flex-direction:column">
              <button id="downloadBtn" class="ghost">Download JSON file</button>
              <button id="copyBtn" class="ghost">Copy JSON to clipboard</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer>
      <div>Private time tracker • data saved locally (browser) • Hosted on GitHub Pages works fine</div>
    </footer>
  </div>

<script>
const STORAGE_KEY = 'timeTrackerEntries_v2';
const colorPalette = {};
const $ = id => document.getElementById(id);

let currentActivity = null;
let timerInterval = null;

const labelInput = $('labelInput');
const startStopBtn = $('startStopBtn');
const timerDisplay = $('timerDisplay');
const viewSelect = $('viewSelect');
const entriesDiv = $('entries');
const totalEntriesEl = $('totalEntries');
const totalTimeEl = $('totalTime');
const refreshBtn = $('refreshBtn');
const exportBtn = $('exportBtn');
const importFile = $('importFile');
const downloadBtn = $('downloadBtn');
const copyBtn = $('copyBtn');
const clearBtn = $('clearBtn');

const ctx = $('pieChart').getContext('2d');
let pieChart = null;

// STORAGE
function loadEntries(){ try{ const raw = localStorage.getItem(STORAGE_KEY); return raw ? JSON.parse(raw) : []; } catch(e){ return []; } }
function saveEntries(arr){ localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); }

// UTIL
function humanDuration(ms){ const minutes=Math.round(ms/60000); if(minutes<60)return minutes+'m'; const h=Math.floor(minutes/60), m=minutes%60; return m===0?h+'h':h+'h '+m+'m'; }
function highlightNewEntry(id){ setTimeout(()=>{ const el=document.querySelector('[data-id="'+id+'"]'); if(!el) return; el.style.transition='background 0.6s'; el.style.background='linear-gradient(90deg, rgba(96,165,250,0.08), rgba(96,165,250,0.02))'; setTimeout(()=>el.style.background='transparent',1400); },80); }

// TIMER HANDLING
function startActivity(){
  const label = labelInput.value.trim();
  if(!label){ alert('Enter an activity name.'); return; }
  currentActivity = { id:'e_'+Math.random().toString(36).slice(2,10), label, startTs: new Date().toISOString() };
  startStopBtn.textContent = 'Stop';
  labelInput.disabled = true;
  timerDisplay.textContent = '00:00';
  timerInterval = setInterval(updateTimer, 1000);
}

function stopActivity(){
  clearInterval(timerInterval);
  currentActivity.endTs = new Date().toISOString();
  currentActivity.durationMs = new Date(currentActivity.endTs) - new Date(currentActivity.startTs);
  const all = loadEntries();
  all.push(currentActivity);
  saveEntries(all);
  currentActivity = null;
  startStopBtn.textContent = 'Start';
  labelInput.disabled = false;
  labelInput.value = '';
  timerDisplay.textContent = '';
  renderAll();
}

function updateTimer(){
  if(!currentActivity) return;
  const elapsed = new Date() - new Date(currentActivity.startTs);
  const mins = Math.floor(elapsed/60000); const secs = Math.floor((elapsed%60000)/1000);
  timerDisplay.textContent = `${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}`;
}

startStopBtn.addEventListener('click',()=>{
  if(currentActivity) stopActivity(); else startActivity();
});

// CHART
function aggregate(entries){
  const map = new Map();
  entries.forEach(e => map.set(e.label, (map.get(e.label)||0) + (e.durationMs||0)));
  return Array.from(map.entries()).map(([label,totalMs])=>({label,totalMs})).sort((a,b)=>b.totalMs-a.totalMs);
}
function filterEntriesByView(all){
  if(viewSelect.value==='24h'){
    const cutoff = Date.now()-(24*60*60*1000);
    return all.filter(e=>new Date(e.startTs).getTime()>=cutoff);
  }
  return all.slice();
}
function getColorForLabel(label){
  if(colorPalette[label]) return colorPalette[label];
  const hue=Math.floor(Math.random()*360);
  const color=`hsl(${hue},70%,50%)`;
  colorPalette[label]=color;
  return color;
}
function renderChart(aggregated){
  const labels = aggregated.map(a=>a.label);
  const data = aggregated.map(a=>a.totalMs/60000);
  const bgColors = aggregated.map(a=>getColorForLabel(a.label));
  if(pieChart) pieChart.destroy();
  pieChart = new Chart(ctx,{
    type:'pie',
    data:{labels,datasets:[{data,backgroundColor:bgColors,borderColor:'rgba(0,0,0,0.2)',borderWidth:1}]},
    options:{plugins:{tooltip:{callbacks:{label:ctx=>{const mins=Math.round(ctx.raw); if(mins<60)return `${ctx.label}: ${mins}m`; const h=Math.floor(mins/60), m=mins%60; return `${ctx.label}: ${h}h ${m}m`;}}}, legend:{position:'bottom',labels:{boxWidth:12,font:{size:12}}}}}
  });
}

// ENTRIES LIST
function renderEntriesList(entries){
  entriesDiv.innerHTML='';
  if(entries.length===0){ entriesDiv.innerHTML='<div class="muted small" style="padding:10px">No entries yet</div>'; return; }
  const sorted = entries.slice().sort((a,b)=>new Date(b.startTs)-new Date(a.startTs));
  for(const e of sorted){
    const el=document.createElement('div'); el.className='entry'; el.dataset.id=e.id;
    const left=document.createElement('div'); left.style.display='flex'; left.style.flexDirection='column'; left.style.gap='4px';
    const pill=document.createElement('span'); pill.className='pill'; pill.textContent=e.label;
    left.appendChild(pill);
    const meta=document.createElement('div'); meta.className='muted small'; meta.textContent=`${humanDuration(e.durationMs)} • ${new Date(e.startTs).toLocaleString()}`;
    left.appendChild(meta);
    const right=document.createElement('div');
    const del=document.createElement('button'); del.className='linklike'; del.textContent='Delete';
    del.onclick=ev=>{ ev.stopPropagation(); if(confirm('Delete this entry?')){ saveEntries(loadEntries().filter(x=>x.id!==e.id)); renderAll(); } };
    right.appendChild(del);
    el.appendChild(left); el.appendChild(right);
    entriesDiv.appendChild(el);
  }
}

// RENDER ALL
function renderAll(){
  const all = loadEntries();
  const filtered = filterEntriesByView(all);
  const aggregated = aggregate(filtered);
  renderChart(aggregated);
  renderEntriesList(all);
  totalEntriesEl.textContent = all.length;
  totalTimeEl.textContent = humanDuration(all.reduce((s,e)=>s+(e.durationMs||0),0));
}

// EXPORT / IMPORT
function getAllJSON(){ return JSON.stringify({exportedAt: new Date().toISOString(), entries: loadEntries()}, null,2); }
downloadBtn.addEventListener('click',()=>{ const blob=new Blob([getAllJSON()],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='time-tracker.json'; a.click(); });
copyBtn.addEventListener('click',async()=>{ try{ await navigator.clipboard.writeText(getAllJSON()); alert('Copied JSON to clipboard'); } catch(e){ alert('Clipboard failed, try download'); } });
exportBtn.addEventListener('click',()=>downloadBtn.click());

importFile.addEventListener('change',ev=>{
  const f=ev.target.files[0]; if(!f) return;
  const reader=new FileReader();
  reader.onload=()=>{
    try{
      const parsed = JSON.parse(reader.result);
      if(!parsed.entries || !Array.isArray(parsed.entries)){ alert('Invalid JSON'); return; }
      if(!confirm('Import will append entries. Continue?')) return;
      const all = loadEntries();
      parsed.entries.forEach(e=>{ e.id = e.id||'e_'+Math.random().toString(36).slice(2,10); all.push(e); });
      saveEntries(all); renderAll();
    } catch(e){ alert('Failed to parse JSON'); }
  };
  reader.readAsText(f);
  ev.target.value='';
});

// CLEAR ALL
clearBtn.addEventListener('click',()=>{ if(confirm('Clear ALL data from this browser?')){ localStorage.removeItem(STORAGE_KEY); renderAll(); } });

// REFRESH & VIEW CHANGE
refreshBtn.addEventListener('click',renderAll);
viewSelect.addEventListener('change',renderAll);

// INIT
renderAll();
labelInput.focus();
</script>
</body>
</html>
